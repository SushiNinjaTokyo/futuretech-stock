<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>futuretech-stock ‚Äî Daily Top 10 ({{ date | default('', true) }})</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --gold:#f6c453; --silver:#cdd2d8; --bronze:#f4a261;
      --soft:#f8fafc; --ring:#e2e8f0;
      --up-bg:#ecfdf5; --up-fg:#065f46; --up-bd:#10b98133;
      --dn-bg:#fef2f2; --dn-fg:#7f1d1d; --dn-bd:#ef444433;
      --nz-fg:#6b7280; --chip-bg:#eef2f7;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--fg)}

    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 24px}
    header{margin-bottom:14px}
    h1{font-size:20px;margin:0 0 6px;letter-spacing:-0.2px}
    .sub{color:var(--muted);font-size:12px}

    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px}
    @media (min-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}

    .card{position:relative;border:1px solid var(--border);border-radius:16px;padding:12px 12px 14px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .left{display:flex;align-items:center;gap:10px;min-width:0}

    .rank-rocket{
      width:64px;height:64px;border-radius:999px;flex:0 0 auto;
      display:flex;align-items:center;justify-content:center;position:relative;isolation:isolate;
      overflow:hidden; box-shadow:0 10px 24px rgba(0,0,0,.08) inset, 0 6px 14px rgba(0,0,0,.06);
    }
    .rank1{ background:radial-gradient(120% 120% at 30% 30%, #fff6d6 0%, var(--gold) 45%, #d59b2b 100%); }
    .rank2{ background:radial-gradient(120% 120% at 30% 30%, #ffffff 0%, var(--silver) 50%, #9ea3a9 100%); }
    .rank3{ background:radial-gradient(120% 120% at 30% 30%, #fff0e5 0%, var(--bronze) 50%, #e4823f 100%); }
    .rankN{ display:none; }

    .rank-badge{
      width:36px;height:36px;border-radius:999px;flex:0 0 auto;
      display:flex;align-items:center;justify-content:center;
      font-weight:800;font-size:13px;letter-spacing:.2px;color:#111827;background:#f3f4f6;border:1px solid var(--border);
    }

    .rocket{ width:30px;height:30px; filter:drop-shadow(0 2px 4px rgba(0,0,0,.18)); }
    .flame{ transform-origin:12px 20px; }
    .rank1 .rocket{ animation:lift-strong 1.6s ease-in-out infinite; }
    .rank1 .flame{ animation:flicker-strong .6s ease-in-out infinite; }
    @keyframes lift-strong{ 0%{transform:translateY(0) rotate(-6deg) scale(1);} 50%{transform:translateY(-5px) rotate(0) scale(1.03);} 100%{transform:translateY(0) rotate(-6deg) scale(1);} }
    @keyframes flicker-strong{ 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:.55;transform:scale(.82);} }

    .rank2 .rocket{ animation:lift 1.8s ease-in-out infinite; }
    .rank2 .flame{ animation:flicker .9s ease-in-out infinite; }
    @keyframes lift{ 0%{transform:translateY(0) rotate(-4deg)} 50%{transform:translateY(-3px) rotate(0)} 100%{transform:translateY(0) rotate(-4deg)} }
    @keyframes flicker{ 0%,100%{opacity:.95; transform:scale(1);} 50%{opacity:.7; transform:scale(.88);} }

    .rank3 .rocket{ animation:prep 1.6s ease-in-out infinite; }
    .rank3 .flame{ opacity:0; }
    @keyframes prep{ 0%{transform:translateY(0) rotate(-2deg)} 50%{transform:translateY(-1px) rotate(1deg)} 100%{transform:translateY(0) rotate(-2deg)} }

    .id-block{min-width:0}
    .symbol{font-size:18px;font-weight:800;letter-spacing:.2px;line-height:1.15;white-space:nowrap}
    .name{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}
    @media (min-width:900px){ .name{max-width:420px} }

    .score{text-align:right;display:flex;flex-direction:column;align-items:flex-end;line-height:1.05;margin-left:auto}
    .score .num{
      font-size:28px;font-weight:900;letter-spacing:-.4px;
      padding:6px 10px;border-radius:12px;border:1px solid var(--ring);
      background:linear-gradient(180deg,#ffffff 0%,#f9fafb 100%);
    }
    .score .den{font-size:11px;color:var(--muted);margin-top:2px}

    .price-row{display:flex;align-items:center;gap:6px;margin-top:8px;flex-wrap:nowrap;overflow:hidden;}
    .pch{flex:1 1 0%; min-width:0; display:flex;align-items:center;justify-content:center;gap:6px;
      padding:6px 8px;border-radius:999px;border:1px solid var(--border); font-size:11px;line-height:1; background:var(--chip-bg); color:#111; white-space:nowrap;}
    .pch .k{color:var(--muted)}
    .pch.up{border-color:var(--up-bd);background:var(--up-bg);color:var(--up-fg)}
    .pch.down{border-color:var(--dn-bd);background:var(--dn-bg);color:var(--dn-fg)}
    .pch.neutral{color:var(--nz-fg)}
    .delta{font-variant-numeric:tabular-nums}

    .medals{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
    .medal{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:4px 8px;line-height:1}
    .medal .label{font-size:11px;letter-spacing:.2px}
    .medal .kind{font-size:11px;color:#111;text-transform:capitalize}
    .medal.gold{border-color:#f59e0b33;box-shadow:0 0 0 2px #f59e0b1a inset}
    .medal.silver{border-color:#9ca3af33;box-shadow:0 0 0 2px #9ca3af1a inset}
    .medal.bronze{border-color:#fb923c33;box-shadow:0 0 0 2px #fb923c1a inset}
    .medal .emoji{font-size:14px}

    .tabs{margin-top:12px}
    .seg{display:inline-flex;gap:0;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:rgba(243,244,246,.6);backdrop-filter:saturate(1.1) blur(2px)}
    .seg .segbtn{appearance:none;border:0;margin:0;padding:8px 12px;background:transparent;cursor:pointer;font-size:12px;color:#111;line-height:1;display:flex;align-items:center;gap:8px;}
    .seg .segbtn:focus{outline:none;box-shadow:inset 0 0 0 2px rgba(0,0,0,.08)}
    .seg .segbtn[aria-pressed="true"]{background:#fff;font-weight:700;box-shadow:inset 0 0 0 1px var(--border);}
    .seg .ico{font-size:14px;opacity:.9}

    .tab{display:none}
    .tab.active{display:block}
    .chart{width:100%;border:1px solid var(--border);border-radius:10px}

    .table{width:100%;border-collapse:collapse;margin-top:6px}
    .table th,.table td{border-bottom:1px solid var(--border);padding:6px 8px;font-size:12px;text-align:left}
    .table th{color:var(--muted);font-weight:600}
    .right{text-align:right}
    .muted{color:var(--muted)}
    details{margin-top:8px;background:#fafafa;border:1px solid var(--border);border-radius:8px;padding:8px 10px}
    details>summary{cursor:pointer;font-size:12px;color:#111;user-select:none}

    .kv{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px}
    .kv div{font-size:12px;background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px 8px}
    .kv .k{color:var(--muted)}
    .note{margin-top:8px;font-size:11px;color:var(--muted)}

    @media (max-width:420px){
      .symbol{font-size:16px}
      .rank-rocket{width:56px;height:56px}
      .rocket{width:28px;height:28px}
      .score .num{font-size:24px}
      .pch{padding:5px 6px;font-size:10.5px}
      .name{max-width:58vw}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>futuretech-stock ‚Äî Daily Top 10</h1>
      <div class="sub">Date: {{ date | default('', true) }} / Scoring: 1000 ptsÔºàvolume anomaly + DII + trends + newsÔºâ</div>
    </header>

    {% if top10 is defined %}
    <div class="grid" id="cards">
      {% for item in top10 %}
        {% set _sym  = item.symbol | default('', true) %}
        {% set _name = item.name   | default('', true) %}
        {% set rank  = (item.rank | default(loop.index, true)) %}
        {% set chart_url = (item.chart_url | default('/charts/' ~ (date | default('', true)) ~ '/' ~ _sym ~ '.png', true)) %}
        {% set pts  = item.score_pts | default((item.final_score_0_1|default(0,true) * 1000) | round(0, 'common'), true) %}

        {# price deltas; fallback safe #}
        {% set d1  = item.price_delta_1d  if item.price_delta_1d  is defined else none %}
        {% set d5  = item.price_delta_1w  if item.price_delta_1w  is defined else none %}
        {% set d20 = item.price_delta_1m  if item.price_delta_1m  is defined else none %}

        {# volume anomaly details if available #}
        {% set vol_detail = (item.detail.vol_anomaly if (item.detail is defined and item.detail and item.detail.vol_anomaly is defined) else none) %}

        <div class="card" id="card-{{ loop.index }}" data-symbol="{{ _sym }}">
          <div class="row">
            <div class="left">
              {% if rank <= 3 %}
                {% set rank_class = 'rank1' if rank==1 else ('rank2' if rank==2 else 'rank3') %}
                <div class="rank-rocket {{ rank_class }}" aria-label="Rank {{ rank }}">
                  <svg class="rocket" viewBox="0 0 24 24" role="img" aria-hidden="true">
                    <path d="M12 3c3 0 6 3.2 6 6.8 0 1.4-.4 2.8-1.1 4l-2.4 4c-.3.6-.9 1-1.6 1h-2.8c-.7 0-1.3-.4-1.6-1l-2.4-4A8.2 8.2 0 0 1 6 9.8C6 6.2 9 3 12 3Z" fill="#ffffff"/>
                    <circle cx="12" cy="9.4" r="2.1" fill="#94a3b8"/>
                    <path d="M7.8 13.5l2.1 3.5H7.6a1 1 0 0 1-.9-1.4l1.1-2.1z" fill="#cbd5e1"/>
                    <path d="M16.2 13.5l-2.1 3.5h2.3c.8 0 1.3-.9.9-1.6l-1.1-1.9z" fill="#cbd5e1"/>
                    <path class="flame" d="M11.2 20.5c-.8-1.2.6-2.4.8-2.9.2.5 1.6 1.7.8 2.9-.5.8-1.9.8-2.4 0z" fill="#f97316"/>
                  </svg>
                </div>
              {% else %}
                <div class="rank-badge" aria-label="Rank {{ rank }}">{{ rank }}</div>
              {% endif %}

              <div class="id-block">
                <div class="symbol">{{ _sym }}</div>
                {% if _name %}<div class="name">{{ _name }}</div>{% endif %}
                <div class="medals"></div>
              </div>
            </div>

            <div class="score">
              <div class="num">{{ pts | int }}</div>
              <div class="den">/ 1000</div>
            </div>
          </div>

          <div class="price-row">
            {% set cls1 = (d1 is not none) and ('up' if d1>0 else ('down' if d1<0 else 'neutral')) or 'neutral' %}
            {% set cls5 = (d5 is not none) and ('up' if d5>0 else ('down' if d5<0 else 'neutral')) or 'neutral' %}
            {% set cls20= (d20 is not none) and ('up' if d20>0 else ('down' if d20<0 else 'neutral')) or 'neutral' %}
            <div class="pch {{ cls1 }}"><span class="k">1D</span><span class="delta">{{ d1 is not none and ("%+.2f%%"|format(d1)) or "‚Äî" }}</span></div>
            <div class="pch {{ cls5 }}"><span class="k">1W</span><span class="delta">{{ d5 is not none and ("%+.2f%%"|format(d5)) or "‚Äî" }}</span></div>
            <div class="pch {{ cls20 }}"><span class="k">1M</span><span class="delta">{{ d20 is not none and ("%+.2f%%"|format(d20)) or "‚Äî" }}</span></div>
          </div>

          <div class="tabs">
            <div class="seg" role="tablist" aria-label="Card sections">
              <button class="segbtn" role="tab" aria-selected="false" aria-pressed="false" data-target="#ov-{{ loop.index }}"><span class="ico">üß≠</span>Overview</button>
              <button class="segbtn" role="tab" aria-selected="false" aria-pressed="false" data-target="#tech-{{ loop.index }}"><span class="ico">üìà</span>Weekly chart</button>
            </div>

            <div id="ov-{{ loop.index }}" class="tab" role="tabpanel" aria-hidden="true">
              <table class="table js-breakdown">
                <thead>
                  <tr>
                    <th>Component</th>
                    <th class="right">Normalized</th>
                    <th class="right">Weight</th>
                    <th class="right">Contribution (pts)</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <th colspan="3" class="right">Total</th>
                    <th class="right"><span class="js-total">{{ pts | int }}</span></th>
                  </tr>
                </tfoot>
              </table>

              <details>
                <summary>Volume anomaly details</summary>
                {% if vol_detail %}
                  {% set rvol20   = vol_detail.get('rvol20') %}
                  {% set z60     = vol_detail.get('z60') %}
                  {% set pr90    = vol_detail.get('pct_rank_90') %}
                  {% set dv      = vol_detail.get('dollar_vol') %}
                  {% set eligible= vol_detail.get('eligible') %}
                  <div class="kv">
                    <div><span class="k">RVOL20</span><br>{{ rvol20 is not none and "%.2f"|format(rvol20) or "-" }}</div>
                    <div><span class="k">Z60</span><br>{{ z60 is not none and "%.2f"|format(z60) or "-" }}</div>
                    <div><span class="k">PctRank90</span><br>{{ pr90 is not none and "%.2f"|format(pr90) or "-" }}</div>
                    <div><span class="k">DollarVol</span><br>{% if dv is not none %}${{ "%.1f"|format(dv/1_000_000) }}M{% else %}-{% endif %}</div>
                    <div><span class="k">Eligible</span><br>{{ eligible and "Yes" or "No" }}</div>
                  </div>
                {% else %}
                  <div class="muted">No details.</div>
                {% endif %}
              </details>

              <details class="js-dii">
                <summary>DII details</summary>
                <div class="muted">Loading‚Ä¶</div>
              </details>

              <div class="note">
                ‚Äª Price changes: 1D=ÂâçÊó•ÊØî, 1W=5Âñ∂Ê•≠Êó•ÂâçÊØî, 1M=20Âñ∂Ê•≠Êó•ÂâçÊØî„ÄÇ<br/>
                ‚Äª DII: Dark/Insider/Institutional „ÅÆÂêàÊàêÊåáÊ®ô„Çí0‚Äì1„Å∏Ê≠£Ë¶èÂåñÔºàÂèñÂæó„Åß„Åç„ÅüÂ†¥ÂêàÔºâ„ÄÇ<br/>
                ‚Äª Trends/News: Google Trends „Å® NewsË®ò‰∫ã√ó„Çª„É≥„ÉÅ„É°„É≥„Éà„ÇíÂÆáÂÆôÂÜÖ„ÅßÊ≠£Ë¶èÂåñ„ÄÇ
              </div>
            </div>

            <div id="tech-{{ loop.index }}" class="tab" role="tabpanel" aria-hidden="true">
              <img src="{{ chart_url }}" alt="{{ _sym }} weekly chart" class="chart" loading="lazy" />
            </div>
          </div>

          <script type="application/json" class="js-payload">
          {{ {
            "symbol": _sym,
            "score_components": (item.score_components if item.score_components is defined else {}),
            "score_weights": (item.score_weights if item.score_weights is defined else {}),
            "final_score_0_1": item.final_score_0_1 | default(0, true),
            "score_pts": pts | int,
            "trends_breakout": item.trends_breakout | default(0, true),
            "news_score": item.news_score | default(0, true),
            "dii_score": (item.dii_score if item.dii_score is defined else (item.insider_momo if item.insider_momo is defined else 0)),
            "vol_anomaly_score": (item.vol_anomaly_score if item.vol_anomaly_score is defined else (item.volume_anomaly if item.volume_anomaly is defined else 0))
          } | tojson }}
          </script>
        </div>
      {% endfor %}
    </div>
    {% else %}
      <div id="cards" class="grid"></div>
    {% endif %}
  </div>

  <script>
    function bindToggles(scope=document){
      scope.querySelectorAll(".card").forEach(card=>{
        const seg = card.querySelector(".seg"); if(!seg) return;
        const buttons = [...seg.querySelectorAll(".segbtn")];
        const panels  = [...card.querySelectorAll(".tab")];

        function openPanel(btn){
          const sel   = btn.getAttribute("data-target");
          const panel = card.querySelector(sel);
          const isActive = panel.classList.contains("active");
          buttons.forEach(b=>{ b.setAttribute("aria-pressed","false"); b.setAttribute("aria-selected","false"); });
          panels.forEach(p=>{ p.classList.remove("active"); p.setAttribute("aria-hidden","true"); });
          if(!isActive){
            btn.setAttribute("aria-pressed","true");
            btn.setAttribute("aria-selected","true");
            panel.classList.add("active");
            panel.setAttribute("aria-hidden","false");
          }
        }
        buttons.forEach(btn=>{
          btn.addEventListener("click", ()=> openPanel(btn));
          btn.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openPanel(btn);} });
        });
      });
    }

    // === Overview breakdown ===
    function fillBreakdown(){
      document.querySelectorAll(".card").forEach(card=>{
        const payloadEl=card.querySelector(".js-payload");
        if(!payloadEl) return;
        let data={};
        try{ data=JSON.parse(payloadEl.textContent||"{}"); }catch(_){}
        const comps = data.score_components||{};
        const weights = data.score_weights||{};

        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Êóß/Êñ∞„Ç≠„Éº„ÅÆ„Å©„Å°„Çâ„Åß„ÇÇË°®Á§∫„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
        const alias = {
          // volume anomaly
          "vol_anomaly":"vol_anomaly","vol_anomaly_score":"vol_anomaly","volume_anomaly":"vol_anomaly",
          // DII / Insider
          "dii_score":"dii","dii":"dii","insider_momo":"dii","form4_score":"dii",
          // trends
          "trends_breakout":"trends","trends":"trends",
          // news
          "news_score":"news","news":"news"
        };

        // ÂèØË¶ñÂåñÈ†Ü„ÇíÂõ∫ÂÆö
        const order = ["vol_anomaly","dii","trends","news"];

        // ÂÄ§Âèñ„ÇäÂá∫„ÅóÔºà0..1„Å´„ÇØ„É©„É≥„ÉóÔºâ
        function getVal(key){
          // comp„Å´ÁÑ°„Åë„Çå„Å∞ payload „ÅÆ„Éà„ÉÉ„Éó„É¨„Éô„É´ÔºàtojsonÂÜÖÔºâ„ÇÇË¶ã„Çã
          const vFromComps = Object.keys(comps).find(k=>alias[k]===key);
          let v = null;
          if(vFromComps){ v = comps[vFromComps]; }
          if(v==null){
            if(key==="vol_anomaly") v = data.vol_anomaly_score ?? data.volume_anomaly ?? null;
            if(key==="dii")         v = data.dii_score ?? null;
            if(key==="trends")      v = data.trends_breakout ?? null;
            if(key==="news")        v = data.news_score ?? null;
          }
          if(v==null) return 0;
          const n=Number(v); if(isNaN(n)) return 0;
          return Math.max(0, Math.min(1, n));
        }

        // Èáç„ÅøÔºàÊú™Êèê‰æõ„Åß„ÇÇÂêàË®à1„Å´„Å™„Çã„Çà„ÅÜÊ≠£Ë¶èÂåñÔºâ
        function getWeightN(key){
          // comps„Å´ÂØæÂøú„Åô„Çã„Ç≠„Éº„Å´Èáç„Åø„Åå„ÅÇ„Çå„Å∞Êãæ„ÅÜ
          let raw=0;
          for(const k in weights){ if(alias[k]===key){ raw = Number(weights[k]||0); break; } }
          return raw;
        }
        const rawWeights = order.map(k=>getWeightN(k));
        const sumRaw = rawWeights.reduce((a,b)=>a+b,0) || 1;
        const normW = rawWeights.map(w=>w/sumRaw);

        const tbody=card.querySelector(".js-breakdown tbody");
        const totalEl=card.querySelector(".js-total");
        if(!tbody) return;
        tbody.innerHTML="";
        let totalPts=0;

        const LABEL = { vol_anomaly:"Volume anomaly", dii:"DII", trends:"Trends breakout", news:"News coverage" };

        order.forEach((k,idx)=>{
          const v = getVal(k);
          const wn = normW[idx];
          const pts = Math.round(v*wn*1000);
          totalPts+=pts;
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${LABEL[k]}</td><td class="right">${v.toFixed(2)}</td><td class="right">${(wn*100).toFixed(0)}%</td><td class="right">${pts}</td>`;
          tbody.appendChild(tr);
        });
        if(totalEl) totalEl.textContent=String(totalPts);
      });
    }

    // === DII details (Â§ñÈÉ®JSON) ===
    async function fillDiiDetails(){
      try{
        const res=await fetch(`/data/dii/latest.json`,{cache:"no-store"});
        if(!res.ok) throw new Error("fetch dii json failed");
        const j=await res.json();
        const items=j.items||j||{};
        document.querySelectorAll(".card").forEach(card=>{
          const sym=card.getAttribute("data-symbol");
          const box=card.querySelector(".js-dii");
          if(!box) return;
          const rec=items[sym] || items[sym?.toUpperCase?.()] || null;
          if(!rec){
            box.innerHTML=`<summary>DII details</summary><div class="muted">No data</div>`;
            return;
          }
          const s30 = Number(rec.score_30 ?? rec.score30 ?? rec.score)?.toFixed(2);
          const s90 = Number(rec.score_90 ?? rec.score90)?.toFixed(2);
          const buyers30 = rec.buyers_30 ?? rec.buyers30 ?? rec.buyers;
          const buyers90 = rec.buyers_90 ?? rec.buyers90;
          const net30 = rec.net_buy_shares_30 ?? rec.net30 ?? 0;
          const net90 = rec.net_buy_shares_90 ?? rec.net90 ?? 0;
          box.innerHTML=`<summary>DII details</summary>
            <div class="kv">
              <div><span class="k">Score 30</span><br>${s30 ?? "-"}</div>
              <div><span class="k">Score 90</span><br>${s90 ?? "-"}</div>
              <div><span class="k">Unique buyers (30d)</span><br>${buyers30 ?? "-"}</div>
              <div><span class="k">Unique buyers (90d)</span><br>${buyers90 ?? "-"}</div>
              <div><span class="k">Net buy (30d)</span><br>${Number(net30||0).toLocaleString()} shares</div>
              <div><span class="k">Net buy (90d)</span><br>${Number(net90||0).toLocaleString()} shares</div>
            </div>`;
        });
      }catch(e){
        document.querySelectorAll(".js-dii").forEach(box=>{
          box.innerHTML=`<summary>DII details</summary><div class="muted">Failed to load</div>`;
        });
      }
    }

    // === Medals: Trends / News Top3 ===
    function decorateTop3Medals(){
      const cards=[...document.querySelectorAll(".card")].map(card=>{
        let data={};
        try{ data=JSON.parse(card.querySelector(".js-payload")?.textContent||"{}"); }catch(_){}
        return {
          card,
          symbol: card.getAttribute("data-symbol"),
          trends: Number(data.trends_breakout||data.trends||0),
          news:   Number(data.news_score||data.news||0)
        };
      });
      const rankBy = (arr, key)=> [...arr]
        .sort((a,b)=>Number(b[key])-Number(a[key]))
        .map((o,i)=>({...o,_rank:i+1}))
        .filter(o=>o[key]>0 && o._rank<=3);
      const tMap=new Map(rankBy(cards,"trends").map(o=>[o.symbol,o._rank]));
      const nMap=new Map(rankBy(cards,"news").map(o=>[o.symbol,o._rank]));
      const medalInfo = r => r===1?{cls:"gold",emoji:"ü•á"}:r===2?{cls:"silver",emoji:"ü•à"}:{cls:"bronze",emoji:"ü•â"};
      cards.forEach(({card,symbol})=>{
        const box=card.querySelector(".medals"); if(!box) return;
        box.innerHTML="";
        const t=tMap.get(symbol); if(t){ const m=medalInfo(t); const el=document.createElement("span");
          el.className=`medal ${m.cls}`; el.title=`Trends Top #${t}`;
          el.innerHTML=`<span class="emoji">${m.emoji}</span><span class="label"><span class="kind">Trends</span></span>`;
          box.appendChild(el);
        }
        const n=nMap.get(symbol); if(n){ const m=medalInfo(n); const el=document.createElement("span");
          el.className=`medal ${m.cls}`; el.title=`News Top #${n}`;
          el.innerHTML=`<span class="emoji">${m.emoji}</span><span class="label"><span class="kind">News</span></span>`;
          box.appendChild(el);
        }
      });
    }

    // INIT
    bindToggles();
    fillBreakdown();
    fillDiiDetails();
    decorateTop3Medals();
  </script>
</body>
</html>
