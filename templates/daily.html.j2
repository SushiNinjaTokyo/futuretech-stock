<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>futuretech-stock — Daily Top 10</title>
<style>
  :root{
    --fg:#0f172a; --sub:#334155; --muted:#64748b; --bg:#ffffff;
    --chip:#f1f5f9; --badge:#e0f2fe; --badge-fg:#075985;
    --card:#ffffff; --border:#e2e8f0; --accent:#111827;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";}
  .container{max-width:1080px;margin:36px auto;padding:0 20px;}
  h1{font-size:22px;line-height:1.2;margin:0 0 6px 0;font-weight:800;letter-spacing:.2px}
  .sub{font-size:12px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px;margin-top:22px}
  @media(min-width:720px){.grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
  @media(min-width:1024px){.grid{grid-template-columns:repeat(3,minmax(0,1fr));}}
  .card{border:1px solid var(--border);border-radius:12px;background:var(--card);padding:14px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .sym{font-weight:800;letter-spacing:.3px}
  .name{color:var(--sub);font-size:12px}
  .score{margin-left:auto;font-size:12px;color:var(--sub)}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .chip{background:var(--chip);border-radius:999px;padding:4px 8px;font-size:12px}
  .chip strong{font-weight:800}
  .badge{background:var(--badge);color:var(--badge-fg);font-weight:700;border-radius:6px;padding:2px 6px;font-size:11px}
  .medal{font-size:12px;margin-left:6px}
  .foot{margin-top:10px;font-size:11px;color:var(--muted)}
  .divider{height:1px;background:var(--border);margin:18px 0 12px}
  .rank{font-weight:900;margin-right:4px}
</style>
</head>
<body>
<div class="container">
  <h1>futuretech-stock — Daily Top 10</h1>
  <div class="sub">
    Date: {{ date }} / Scoring: 1000 pts
    <span style="color:var(--muted)">&nbsp; (volume anomaly + DII + trends + news)</span>
  </div>

  {# ===== データ源の揺れ(ranking/top10)を統一 ===== #}
  {% set items = ranking if ranking is defined else (top10 if top10 is defined else []) %}

  {# ===== Top3 メダル用の事前計算（存在する場合のみ） ===== #}
  {% set by_trends = items | selectattr('score_components','defined')
                           | sort(attribute='score_components.trends_breakout', reverse=True) %}
  {% set by_news   = items | selectattr('score_components','defined')
                           | sort(attribute='score_components.news_score', reverse=True) %}
  {% set top3_trends = by_trends[:3] | map(attribute='symbol') | list %}
  {% set top3_news   = by_news[:3]   | map(attribute='symbol') | list %}

  <div class="grid">
    {% for it in items %}
      {% set sc = it.score_components if it.score_components is defined else {} %}
      {% set det = it.detail if it.detail is defined else {} %}
      {% set vol = det.vol_anomaly if det.vol_anomaly is defined else {} %}

      <div class="card">
        <div class="row">
          <span class="rank">#{{ it.rank }}</span>
          <span class="sym">{{ it.symbol }}</span>
          <span class="name">— {{ it.name }}</span>

          {# 出来高異常バッジ（あれば） #}
          {% if vol and (vol.is_anomaly is defined and vol.is_anomaly) %}
            <span class="badge">Volume anomaly</span>
          {% endif %}

          <span class="score">Score: {{ '%d' % (it.score_pts if it.score_pts is defined else 0) }} pts</span>
        </div>

        <div class="chips">
          {# ラベル正規化：知らないキーはそのまま #}
          {% macro label(k) -%}
            {%- if k == 'vol_anomaly_score' -%}Volume
            {%- elif k == 'insider_momo' -%}DII
            {%- elif k == 'trends_breakout' -%}Trends
            {%- elif k == 'news_score' -%}News
            {%- else -%}{{ k }}
            {%- endif -%}
          {%- endmacro %}

          {# キーがあるものだけ並べる。値は 0–1 を % 表示、その他はそのまま #}
          {% for key in ['vol_anomaly_score','insider_momo','trends_breakout','news_score'] if sc[key] is defined %}
            {% set val = sc[key] %}
            {% if val is number %}
              <span class="chip"><strong>{{ label(key) }}</strong>&nbsp;{{ '%.0f' % (val*100) }}%</span>
            {% else %}
              <span class="chip"><strong>{{ label(key) }}</strong>&nbsp;{{ val }}</span>
            {% endif %}
          {% endfor %}

          {# 予期しない追加成分もサイレント表示（壊さない） #}
          {% for k,v in sc.items() if k not in ['vol_anomaly_score','insider_momo','trends_breakout','news_score'] %}
            {% if v is number %}
              <span class="chip"><strong>{{ label(k) }}</strong>&nbsp;{{ '%.0f' % (v*100) }}%</span>
            {% else %}
              <span class="chip"><strong>{{ label(k) }}</strong>&nbsp;{{ v }}</span>
            {% endif %}
          {% endfor %}
        </div>

        {# メダル（該当時のみ） #}
        <div class="row" style="margin-top:8px">
          {% if it.symbol in top3_trends %}
            <span class="medal">🥇 Trends Top3</span>
          {% endif %}
          {% if it.symbol in top3_news %}
            <span class="medal">🏅 News Top3</span>
          {% endif %}
        </div>

        <div class="divider"></div>

        <div class="foot">
          Final: {{ '%.0f' % ((it.final_score_0_1 if it.final_score_0_1 is defined else 0)*100) }}%
          {% if vol and vol.ratio is defined %} ・ Vol×{{ '%.1f' % vol.ratio }}{% endif %}
          {% if vol and vol.zscore is defined %} ・ z={{ '%.2f' % vol.zscore }}{% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>
</body>
</html>
