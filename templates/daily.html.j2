<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>futuretech-stock — Daily Top 10 ({{ date | default('', true) }})</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/daily.css?v={{ css_version }}">
  <meta name="color-scheme" content="light dark" />
</head>
<body>
  <div class="wrap">
    <header>
      <h1>futuretech-stock — Daily Top 10</h1>
      <div class="sub">Date: {{ date | default('', true) }} / Scoring: 1000 pts（volume + insider + trends + news）</div>
    </header>

    {% set items = top10 or [] %}
    {% if items | length > 0 %}
    <div class="grid" id="cards">
      {% for item in items %}
        {# -------- フォールバック群（shapeの違いを吸収） -------- #}
        {% set _sym = (item.symbol if item.symbol is defined and item.symbol
                       else (item.ticker if item.ticker is defined and item.ticker
                             else (item.code if item.code is defined and item.code else '-'))) %}
        {% set _name = (item.name if item.name is defined and item.name
                        else (item.company if item.company is defined and item.company else '')) %}
        {% set rank = item.rank | default(loop.index, true) %}
        {% set chart_url = (item.chart_url
                           | default('/charts/' ~ (date | default('', true)) ~ '/' ~ _sym ~ '.png', true)) %}

        {# スコア（0–1）を多段フォールバック #}
        {% set s01 =
          (item.score if item.score is defined else
           (item.final_score_0_1 if item.final_score_0_1 is defined else
            (item.score_0_1 if item.score_0_1 is defined else
             (item.score01 if item.score01 is defined else 0)))) %}
        {% set pts = (item.score_pts if item.score_pts is defined
                      else (s01 * 1000) | round(0, 'common')) %}

        {# volume anomaly 詳細 #}
        {% if item.detail is defined and item.detail and item.detail.vol_anomaly is defined %}
          {% set vol = item.detail.vol_anomaly %}
        {% elif item.components is defined and item.components and item.components.volume_anom_detail is defined %}
          {% set vol = item.components.volume_anom_detail %}
        {% else %}
          {% set vol = none %}
        {% endif %}

        {# price deltas: 1D/1W/1M の多段フォールバック #}
        {% set d1 = (item.price_delta_1d if item.price_delta_1d is defined
                     else (item.delta_1d_pct if item.delta_1d_pct is defined
                           else (item.change1d_pct if item.change1d_pct is defined else none))) %}

        {% set d5 = (item.price_delta_1w if item.price_delta_1w is defined
                     else (item.delta_5d_pct if item.delta_5d_pct is defined
                           else (item.delta_1w_pct if item.delta_1w_pct is defined else none))) %}

        {% set d20 = (item.price_delta_1m if item.price_delta_1m is defined
                      else (item.delta_20d_pct if item.delta_20d_pct is defined
                            else (item.delta_1m_pct if item.delta_1m_pct is defined else none))) %}

        <div class="card" id="card-{{ loop.index }}" data-symbol="{{ _sym }}">
          <div class="row">
            <div class="left">
              {% if rank <= 3 %}
                {% set rank_class = 'rank1' if rank==1 else ('rank2' if rank==2 else 'rank3') %}
                <div class="rank-rocket {{ rank_class }}" aria-label="Rank {{ rank }}">
                  <!-- rocket SVG -->
                  <svg class="rocket" viewBox="0 0 24 24" role="img" aria-hidden="true">
                    <path d="M12 3c3 0 6 3.2 6 6.8 0 1.4-.4 2.8-1.1 4l-2.4 4c-.3.6-.9 1-1.6 1h-2.8c-.7 0-1.3-.4-1.6-1l-2.4-4A8.2 8.2 0 0 1 6 9.8C6 6.2 9 3 12 3Z" fill="#ffffff"/>
                    <circle cx="12" cy="9.4" r="2.1" fill="#94a3b8"/>
                    <path d="M7.8 13.5l2.1 3.5H7.6a1 1 0 0 1-.9-1.4l1.1-2.1z" fill="#cbd5e1"/>
                    <path d="M16.2 13.5l-2.1 3.5h2.3c.8 0 1.3-.9.9-1.6l-1.1-1.9z" fill="#cbd5e1"/>
                    <path class="flame" d="M11.2 20.5c-.8-1.2.6-2.4.8-2.9.2.5 1.6 1.7.8 2.9-.5.8-1.9.8-2.4 0z" fill="#f97316"/>
                  </svg>
                </div>
              {% else %}
                <div class="rank-badge" aria-label="Rank {{ rank }}">{{ rank }}</div>
              {% endif %}

              <div class="id-block">
                <div class="symbol">{{ _sym }}</div>
                {% if _name %}<div class="name">{{ _name }}</div>{% endif %}
                <div class="medals"></div>
              </div>
            </div>

            <div class="score">
              <div class="num">{{ pts | int }}</div>
              <div class="den">/ 1000</div>
            </div>
          </div>

          <div class="price-row">
            {% set cls1 = (d1 is not none) and ('up' if d1>0 else ('down' if d1<0 else 'neutral')) or 'neutral' %}
            {% set cls5 = (d5 is not none) and ('up' if d5>0 else ('down' if d5<0 else 'neutral')) or 'neutral' %}
            {% set cls20= (d20 is not none) and ('up' if d20>0 else ('down' if d20<0 else 'neutral')) or 'neutral' %}
            <div class="pch {{ cls1 }}"><span class="k">1D</span><span class="delta">{{ d1 is not none and ("%+.2f%%"|format(d1)) or "—" }}</span></div>
            <div class="pch {{ cls5 }}"><span class="k">1W</span><span class="delta">{{ d5 is not none and ("%+.2f%%"|format(d5)) or "—" }}</span></div>
            <div class="pch {{ cls20 }}"><span class="k">1M</span><span class="delta">{{ d20 is not none and ("%+.2f%%"|format(d20)) or "—" }}</span></div>
          </div>

          <div class="tabs">
            <div class="seg" role="tablist" aria-label="Card sections">
              <button class="segbtn" role="tab" aria-selected="false" aria-pressed="false"
                      data-target="#ov-{{ loop.index }}"><span class="ico">🧭</span>Overview</button>
              <button class="segbtn" role="tab" aria-selected="false" aria-pressed="false"
                      data-target="#tech-{{ loop.index }}"><span class="ico">📈</span>Weekly chart</button>
            </div>

            <div id="ov-{{ loop.index }}" class="tab" role="tabpanel" aria-hidden="true">
              <table class="table js-breakdown">
                <thead>
                  <tr>
                    <th>Component</th>
                    <th class="right">Normalized</th>
                    <th class="right">Weight</th>
                    <th class="right">Contribution (pts)</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <th colspan="3" class="right">Total</th>
                    <th class="right"><span class="js-total">{{ pts | int }}</span></th>
                  </tr>
                </tfoot>
              </table>

              <details>
                <summary>Volume anomaly details</summary>
                {% if vol %}
                  {% set rvol20 = vol.get('rvol20') %}
                  {% set z60 = vol.get('z60') %}
                  {% set pr90 = vol.get('pct_rank_90') %}
                  {% set dv = vol.get('dollar_vol') %}
                  {% set eligible = vol.get('eligible') %}
                  <div class="kv">
                    <div><span class="k">RVOL20</span><br>{{ rvol20 is not none and "%.2f"|format(rvol20) or "-" }}</div>
                    <div><span class="k">Z60</span><br>{{ z60 is not none and "%.2f"|format(z60) or "-" }}</div>
                    <div><span class="k">PctRank90</span><br>{{ pr90 is not none and "%.2f"|format(pr90) or "-" }}</div>
                    <div><span class="k">DollarVol</span><br>{% if dv is not none %}${{ "%.1f"|format(dv/1_000_000) }}M{% else %}-{% endif %}</div>
                    <div><span class="k">Eligible</span><br>{{ eligible and "Yes" or "No" }}</div>
                  </div>
                {% else %}
                  <div class="muted">No details.</div>
                {% endif %}
              </details>

              <details class="js-insider">
                <summary>Insider details (Form 4)</summary>
                <div class="muted">Loading…</div>
              </details>

              <div class="note">
                ※ Price changes: 1D = 前営業日比, 1W = 5営業日前比, 1M = 20営業日前比。<br/>
                ※ Trends: Google Trends の相対スコア（直近ウィンドウ基準）。News: 直近記事数×簡易センチメントを宇宙内パーセンタイル正規化。<br/>
                ※ Insider: 直近 Form 4 指標（スコア30/90など）を0–1へ縮約。
              </div>
            </div>

            <div id="tech-{{ loop.index }}" class="tab" role="tabpanel" aria-hidden="true">
              <img src="{{ chart_url }}" alt="{{ _sym }} weekly chart" class="chart" loading="lazy" />
            </div>
          </div>

          <script type="application/json" class="js-payload">
          {{ {
            "symbol": _sym,
            "components": (item.components if item.components is defined else {}),
            "score_components": (item.score_components if item.score_components is defined else (item.components if item.components is defined else {})),
            "score_weights": (item.score_weights if item.score_weights is defined else {}),
            "final_score_0_1": s01,
            "score_pts": pts | int,
            "insider_momo": (item.insider_momo if item.insider_momo is defined else ((item.components.insider_momo) if (item.components is defined and item.components.insider_momo is defined) else 0)),
            "trends_breakout": (item.trends_breakout if item.trends_breakout is defined else ((item.components.trends) if (item.components is defined and item.components.trends is defined) else 0)),
            "vol_anomaly_score": (item.vol_anomaly_score if item.vol_anomaly_score is defined else ((item.components.volume_anom) if (item.components is defined and item.components.volume_anom is defined) else ((item.components.volume) if (item.components is defined and item.components.volume is defined) else 0))),
            "news_score": (item.news_score if item.news_score is defined else ((item.components.news) if (item.components is defined and item.components.news is defined) else 0)),
            "news_recent_count": (item.news_recent_count if item.news_recent_count is defined else (item.news_count if item.news_count is defined else 0))
          } | tojson }}
          </script>
        </div>
      {% endfor %}
    </div>
    {% else %}
      <div class="notice warn">No ranking data found for {{ date }}.</div>
    {% endif %}
  </div>

  <script>
    // Segmented toggle
    function bindToggles(scope=document){
      scope.querySelectorAll(".card").forEach(card=>{
        const seg = card.querySelector(".seg");
        if(!seg) return;
        const buttons = [...seg.querySelectorAll(".segbtn")];
        const panels  = [...card.querySelectorAll(".tab")];

        function openPanel(btn){
          const sel   = btn.getAttribute("data-target");
          const panel = card.querySelector(sel);
          const isActive = panel.classList.contains("active");
          buttons.forEach(b=>{ b.setAttribute("aria-pressed","false"); b.setAttribute("aria-selected","false"); });
          panels.forEach(p=>{ p.classList.remove("active"); p.setAttribute("aria-hidden","true"); });
          if(!isActive){
            btn.setAttribute("aria-pressed","true");
            btn.setAttribute("aria-selected","true");
            panel.classList.add("active");
            panel.setAttribute("aria-hidden","false");
          }
        }
        buttons.forEach(btn=>{
          btn.addEventListener("click", ()=> openPanel(btn));
          btn.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openPanel(btn);} });
        });
      });
    }

    // Breakdown table（score_components or components を使用）
    function fillBreakdown(){
      document.querySelectorAll(".card").forEach(card=>{
        const payloadEl=card.querySelector(".js-payload");
        if(!payloadEl) return;
        let data={};
        try{ data=JSON.parse(payloadEl.textContent||"{}"); }catch(_){}
        const comps=data.score_components && Object.keys(data.score_components).length ? data.score_components : (data.components||{});
        const weights=data.score_weights||{};
        const keys=Object.keys(comps).filter(k=>comps[k]!=null);
        const wsum=keys.reduce((s,k)=>s+Math.max(0,Number(weights[k]||0)),0)||1;

        const tbody=card.querySelector(".js-breakdown tbody");
        const totalEl=card.querySelector(".js-total");
        if(!tbody) return;
        tbody.innerHTML="";
        let totalPts=0;

        const label=k=>({
          volume_anomaly:"Volume anomaly",
          volume:"Volume anomaly",
          volume_anom:"Volume anomaly",
          insider_momo:"Insider momentum",
          trends_breakout:"Trends breakout",
          trends:"Trends breakout",
          news:"News coverage"
        }[k]||k);

        keys.forEach(k=>{
          const v=Math.max(0,Math.min(1,Number(comps[k]||0)));
          const wn=Math.max(0,Number(weights[k]||0))/wsum;
          const pts=Math.round(v*wn*1000);
          totalPts+=pts;
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${label(k)}</td><td class="right">${v.toFixed(2)}</td><td class="right">${(wn*100).toFixed(0)}%</td><td class="right">${pts}</td>`;
          tbody.appendChild(tr);
        });
        if(totalEl) totalEl.textContent=String(totalPts);
      });
    }

    // Insider details
    async function fillInsiderDetails(){
      try{
        const res=await fetch(`/data/insider/form4_latest.json`,{cache:"no-store"});
        if(!res.ok) throw new Error("fetch insider json failed");
        const j=await res.json();
        const items=j.items||{};
        document.querySelectorAll(".card").forEach(card=>{
          const sym=card.getAttribute("data-symbol");
          const box=card.querySelector(".js-insider");
          if(!box) return;
          const rec=items[sym];
          if(!rec){ box.innerHTML=`<summary>Insider details (Form 4)</summary><div class="muted">No data</div>`; return; }
          box.innerHTML=`<summary>Insider details (Form 4)</summary>
            <div class="kv">
              <div><span class="k">Net buy (30d)</span><br>${(rec.net_buy_shares_30||0).toLocaleString()} shares</div>
              <div><span class="k">Net buy (90d)</span><br>${(rec.net_buy_shares_90||0).toLocaleString()} shares</div>
              <div><span class="k">Unique buyers (30d)</span><br>${(rec.buyers_30||0)}</div>
              <div><span class="k">Unique buyers (90d)</span><br>${(rec.buyers_90||0)}</div>
              <div><span class="k">Score 30</span><br>${Number(rec.score_30||0).toFixed(2)}</div>
              <div><span class="k">Score 90</span><br>${Number(rec.score_90||0).toFixed(2)}</div>
            </div>`;
        });
      }catch(e){
        document.querySelectorAll(".js-insider").forEach(box=>{
          box.innerHTML=`<summary>Insider details (Form 4)</summary><div class="muted">Failed to load</div>`;
        });
      }
    }

    // News/Trends medals Top3（score_components / components 両対応）
    function decorateTop3Medals(){
      const cards=[...document.querySelectorAll(".card")].map(card=>{
        let data={};
        try{ data=JSON.parse(card.querySelector(".js-payload")?.textContent||"{}"); }catch(_){}
        const trends = Number(
          (data.trends_breakout ?? data.components?.trends ?? data.score_components?.trends ?? 0)
        );
        const news   = Number(
          (data.news_score ?? data.components?.news ?? data.score_components?.news ?? 0)
        );
        return { card, symbol: card.getAttribute("data-symbol"), trends, news };
      });
      const rankBy = (arr, key)=>
        [...arr].sort((a,b)=>Number(b[key])-Number(a[key]))
                .map((o,i)=>({...o,_rank:i+1}))
                .filter(o=>o[key]>0 && o._rank<=3);
      const tMap=new Map(rankBy(cards,"trends").map(o=>[o.symbol,o._rank]));
      const nMap=new Map(rankBy(cards,"news").map(o=>[o.symbol,o._rank]));
      const medalInfo = r => r===1?{cls:"gold",emoji:"🥇"}:r===2?{cls:"silver",emoji:"🥈"}:{cls:"bronze",emoji:"🥉"};
      cards.forEach(({card,symbol})=>{
        const box=card.querySelector(".medals"); if(!box) return;
        box.innerHTML="";
        const t=tMap.get(symbol); if(t){ const m=medalInfo(t); const el=document.createElement("span");
          el.className=`medal ${m.cls}`; el.title=`Trends Top #${t}`;
          el.innerHTML=`<span class="emoji">${m.emoji}</span><span class="label"><span class="kind">Trends</span></span>`;
          box.appendChild(el);
        }
        const n=nMap.get(symbol); if(n){ const m=medalInfo(n); const el=document.createElement("span");
          el.className=`medal ${m.cls}`; el.title=`News Top #${n}`;
          el.innerHTML=`<span class="emoji">${m.emoji}</span><span class="label"><span class="kind">News</span></span>`;
          box.appendChild(el);
        }
      });
    }

    // INIT
    bindToggles();
    fillBreakdown();
    fillInsiderDetails();
    decorateTop3Medals();
  </script>
</body>
</html>
